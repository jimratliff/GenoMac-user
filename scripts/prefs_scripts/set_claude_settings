# This file assumes:
# - GENOMAC_HELPER_DIR is already set in the current shell to the absolute path of the directory 
#   containing helpers.sh.
# These environment variables must be defined by assign_environment_variables.sh

if [[ -z "${GENOMAC_HELPER_DIR:-}" ]]; then
  echo "âŒ GENOMAC_HELPER_DIR is not set. Please source initial_prefs.sh first."
  return 1
fi

source "${GENOMAC_HELPER_DIR}/helpers.sh"

############################## BEGIN SCRIPT PROPER ##############################

function set_claude_settings() {

  report_start_phase_standard
  report_action_taken "Implement Claude desktop settings"

  local claude_config_path="${HOME}/Library/Application Support/Claude/claude_desktop_config.json"
  local claude_config_dir="${claude_config_path:h}"
  local tmpfile
  local jq_filter

  # Single jq filter we apply exactly once
  jq_filter='
    .preferences = (.preferences // {}) |
    .preferences.quickEntryShortcut = "off" |
    .preferences.menuBarEnabled = false
  '

  report_adjust_setting "Ensure Claude config directory exists: ${claude_config_dir}"
  mkdir -p "${claude_config_dir}" ; success_or_not

  # If file is missing or empty, start with minimal valid JSON
  if [[ ! -f "${claude_config_path}" || ! -s "${claude_config_path}" ]]; then
    report_adjust_setting "Initialize Claude config file at: ${claude_config_path}"
    printf '%s\n' '{}' > "${claude_config_path}" ; success_or_not
  fi

  # Now we *always* operate on the existing file (which is guaranteed non-empty JSON)
  tmpfile="$(mktemp "${TMPDIR:-/tmp}/claude_config.XXXXXX")"

  report_adjust_setting "Apply Claude preference updates via jq"
  jq "${jq_filter}" "${claude_config_path}" > "${tmpfile}" ; success_or_not

  report_adjust_setting "Save updated Claude config to ${claude_config_path}"
  mv "${tmpfile}" "${claude_config_path}" ; success_or_not

  report_end_phase_standard
}

############################### END SCRIPT PROPER ###############################
